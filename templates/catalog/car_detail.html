{% extends "base.html" %}

{% block title %}{{ car.name }} - CHI AUTO{% endblock %}

{% block content %}
<div class="car-detail-page">
    <!-- Кнопка назад -->
    <header class="detail-header">
        <button class="btn-back" onclick="history.back()">
            <i class='bx bx-arrow-back'></i>
        </button>
        <h1>{{ car.name }}</h1>
        <div class="header-actions">
            <button class="btn-share" onclick="shareCar('{{ car.id }}')">
                <i class='bx bx-share-alt'></i>
            </button>
        </div>
    </header>

    <!-- Галерея изображений -->
    <section class="car-gallery">
        <div class="main-image">
            <img src="{{ url_for('static', filename='images/cars/' + car.images[0]) }}" alt="{{ car.name }}" id="mainImage">
        </div>
        {% if car.images|length > 1 %}
        <div class="image-thumbnails">
            {% for image in car.images %}
            <div class="thumbnail {% if loop.first %}active{% endif %}" onclick="changeImage('{{ url_for('static', filename='images/cars/' + image) }}', this)">
                <img src="{{ url_for('static', filename='images/cars/' + image) }}" alt="{{ car.name }} - фото {{ loop.index }}">
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>

    <!-- Основная информация -->
    <section class="car-main-info">
        <div class="price-section">
            <div class="price-main">{{ "{:,}".format(car.price).replace(",", " ") }} ₽</div>
            <div class="price-rental">
                <span>Аренда: {{ car.daily_rent }} ₽/сутки</span>
                <span class="price-discount">от 10 дней: {{ car.weekly_discount }} ₽/сутки</span>
            </div>
        </div>

        <div class="availability-badge {{ 'available' if car.available else 'unavailable' }}">
            <i class='bx bx-{{ "check" if car.available else "x" }}'></i>
            {{ 'В наличии' if car.available else 'Нет в наличии' }}
        </div>
    </section>

    <!-- Характеристики -->
    <section class="car-specs-section">
        <h2 class="section-title">Характеристики</h2>
        <div class="specs-grid">
            <div class="spec-item">
                <div class="spec-icon">
                    <i class='bx bx-calendar'></i>
                </div>
                <div class="spec-info">
                    <span class="spec-label">Год выпуска</span>
                    <span class="spec-value">{{ car.year }} г.</span>
                </div>
            </div>

            <div class="spec-item">
                <div class="spec-icon">
                    <i class='bx bx-chip'></i>
                </div>
                <div class="spec-info">
                    <span class="spec-label">Двигатель</span>
                    <span class="spec-value">{{ car.engine }}</span>
                </div>
            </div>

            <div class="spec-item">
                <div class="spec-icon">
                    <i class='bx bx-cog'></i>
                </div>
                <div class="spec-info">
                    <span class="spec-label">Коробка передач</span>
                    <span class="spec-value">{{ car.transmission }}</span>
                </div>
            </div>

            <div class="spec-item">
                <div class="spec-icon">
                    <i class='bx bx-tachometer'></i>
                </div>
                <div class="spec-info">
                    <span class="spec-label">Привод</span>
                    <span class="spec-value">{{ car.drive }}</span>
                </div>
            </div>

            <div class="spec-item">
                <div class="spec-icon">
                    <i class='bx bx-gas-pump'></i>
                </div>
                <div class="spec-info">
                    <span class="spec-label">Топливо</span>
                    <span class="spec-value">{{ car.fuel }}</span>
                </div>
            </div>

            <div class="spec-item">
                <div class="spec-icon">
                    <i class='bx bx-bolt'></i>
                </div>
                <div class="spec-info">
                    <span class="spec-label">Мощность</span>
                    <span class="spec-value">{{ car.power }}</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Описание -->
    <section class="car-description">
        <h2 class="section-title">Описание</h2>
        <div class="description-content">
            <p>{{ car.description }}</p>
        </div>
    </section>

    <!-- Особенности -->
    {% if car.features %}
    <section class="car-features">
        <h2 class="section-title">Особенности и опции</h2>
        <div class="features-grid">
            {% for feature in car.features %}
            <div class="feature-item">
                <i class='bx bx-check'></i>
                <span>{{ feature }}</span>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Доступность по городам -->
    <section class="car-availability">
        <h2 class="section-title">Доступен в городах</h2>
        <div class="cities-list">
            {% for city_id in car.cities %}
            {% set city_data = cities[city_id] %}
            <div class="city-availability-item" onclick="openPage('/city/{{ city_id }}')">
                <div class="city-info">
                    <h4>{{ city_data.name }}</h4>
                    <p>{{ city_data.address }}</p>
                </div>
                <div class="city-contact">
                    <span class="city-phone">{{ city_data.phone }}</span>
                    <i class='bx bx-chevron-right'></i>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- Кнопки действий -->
    <section class="car-actions">
        <div class="action-buttons">
            <button class="btn-action primary large" onclick="openRentModal('{{ car.id }}', '{{ car.name }}')" {{ 'disabled' if not car.available }}>
                <i class='bx bx-calendar'></i>
                Арендовать
            </button>
            <button class="btn-action secondary large" onclick="openContactModal('{{ car.name }}')">
                <i class='bx bx-phone'></i>
                Консультация
            </button>
        </div>
    </section>
</div>

<!-- Модальное окно аренды -->
<div id="rentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Аренда автомобиля</h3>
            <button class="modal-close" onclick="closeRentModal()">
                <i class='bx bx-x'></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="rent-car-info">
                <h4 id="rentCarName"></h4>
                <div class="rent-prices">
                    <div class="rent-price-item">
                        <span>Сутки:</span>
                        <span id="rentDailyPrice"></span>
                    </div>
                    <div class="rent-price-item discount">
                        <span>От 10 дней:</span>
                        <span id="rentWeeklyPrice"></span>
                    </div>
                </div>
            </div>

            <form id="rentForm" class="rent-form">
                <div class="form-group">
                    <label for="rentName">Ваше имя</label>
                    <input type="text" id="rentName" required placeholder="Введите ваше имя">
                </div>

                <div class="form-group">
                    <label for="rentPhone">Телефон</label>
                    <input type="tel" id="rentPhone" required placeholder="+7 (___) ___-__-__">
                </div>

                <div class="form-group">
                    <label for="rentCity">Город</label>
                    <select id="rentCity" required>
                        <option value="">Выберите город</option>
                        {% for city_id in car.cities %}
                        <option value="{{ city_id }}">{{ cities[city_id].name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="rentDates">Даты аренды</label>
                    <input type="text" id="rentDates" required placeholder="Выберите даты" readonly>
                </div>

                <div class="form-group">
                    <label for="rentComment">Комментарий</label>
                    <textarea id="rentComment" placeholder="Дополнительные пожелания..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-action secondary" onclick="closeRentModal()">
                Отмена
            </button>
            <button type="submit" form="rentForm" class="btn-action primary">
                Отправить заявку
            </button>
        </div>
    </div>
</div>

<style>
.car-detail-page {
    padding-bottom: 100px;
}

/* Заголовок */
.detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding: 0 8px;
}

.detail-header h1 {
    font-size: 20px;
    font-weight: 700;
    color: #f8fafc;
    text-align: center;
    flex: 1;
    margin: 0 12px;
}

.btn-back, .btn-share {
    background: rgba(96, 165, 250, 0.2);
    border: 1px solid #60a5fa;
    color: #bfdbfe;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-back:hover, .btn-share:hover {
    background: rgba(96, 165, 250, 0.3);
    transform: translateY(-1px);
}

/* Галерея */
.car-gallery {
    margin-bottom: 20px;
}

.main-image {
    width: 100%;
    height: 250px;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 12px;
}

.main-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-thumbnails {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 8px 0;
}

.thumbnail {
    width: 80px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.thumbnail.active {
    border-color: #60a5fa;
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Основная информация */
.car-main-info {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #3730a3;
}

.price-section {
    margin-bottom: 16px;
}

.price-main {
    font-size: 28px;
    font-weight: 800;
    color: #86efac;
    margin-bottom: 8px;
}

.price-rental {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.price-rental span {
    font-size: 16px;
    color: #c7d2fe;
}

.price-discount {
    color: #bbf7d0 !important;
    font-size: 14px !important;
}

.availability-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.availability-badge.available {
    background: rgba(34, 197, 94, 0.2);
    color: #bbf7d0;
    border: 1px solid rgba(74, 222, 128, 0.4);
}

.availability-badge.unavailable {
    background: rgba(239, 68, 68, 0.2);
    color: #fecaca;
    border: 1px solid rgba(248, 113, 113, 0.4);
}

/* Характеристики */
.car-specs-section {
    margin-bottom: 24px;
}

.specs-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}

.spec-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 12px;
    border: 1px solid #3730a3;
}

.spec-icon {
    width: 40px;
    height: 40px;
    background: rgba(96, 165, 250, 0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #60a5fa;
}

.spec-icon i {
    font-size: 20px;
    color: #60a5fa;
}

.spec-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.spec-label {
    font-size: 12px;
    color: #bfdbfe;
}

.spec-value {
    font-size: 14px;
    font-weight: 600;
    color: #f8fafc;
}

/* Описание */
.car-description {
    margin-bottom: 24px;
}

.description-content {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #3730a3;
}

.description-content p {
    color: #e2e8f0;
    line-height: 1.6;
}

/* Особенности */
.car-features {
    margin-bottom: 24px;
}

.features-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 12px;
    border: 1px solid #3730a3;
}

.feature-item i {
    color: #22c55e;
    font-size: 18px;
}

.feature-item span {
    color: #e2e8f0;
    font-size: 14px;
}

/* Доступность по городам */
.car-availability {
    margin-bottom: 24px;
}

.cities-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.city-availability-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 12px;
    border: 1px solid #3730a3;
    cursor: pointer;
    transition: all 0.3s ease;
}

.city-availability-item:hover {
    border-color: #60a5fa;
    transform: translateY(-1px);
}

.city-info h4 {
    font-size: 16px;
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 4px;
}

.city-info p {
    font-size: 12px;
    color: #bfdbfe;
}

.city-contact {
    display: flex;
    align-items: center;
    gap: 12px;
}

.city-phone {
    font-size: 14px;
    color: #60a5fa;
    font-weight: 500;
}

.city-contact i {
    color: #94a3b8;
    font-size: 20px;
}

/* Кнопки действий */
.car-actions {
    position: fixed;
    bottom: 70px;
    left: 16px;
    right: 16px;
    background: #0a1128;
    padding: 16px 0;
    border-top: 1px solid #1e3a8a;
}

.action-buttons {
    display: flex;
    gap: 12px;
}

.btn-action.large {
    flex: 1;
    padding: 16px 20px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-action.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    color: white;
}

.btn-action.secondary {
    background: rgba(96, 165, 250, 0.2);
    border: 1px solid #60a5fa;
    color: #bfdbfe;
}

.btn-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.btn-action:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
}

/* Модальное окно */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 17, 40, 0.9);
    backdrop-filter: blur(5px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-radius: 20px;
    border: 1px solid #3730a3;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #3730a3;
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: #f8fafc;
}

.modal-close {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 24px;
    cursor: pointer;
    transition: color 0.3s ease;
}

.modal-close:hover {
    color: #f8fafc;
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid #3730a3;
}

/* Адаптивность */
@media (min-width: 768px) {
    .specs-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .features-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .detail-header h1 {
        font-size: 24px;
    }

    .main-image {
        height: 300px;
    }
}

@media (min-width: 1024px) {
    .specs-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}
</style>

<script>
// Функции для галереи
function changeImage(src, element) {
    document.getElementById('mainImage').src = src;

    // Убираем активный класс у всех миниатюр
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });

    // Добавляем активный класс к выбранной миниатюре
    element.classList.add('active');
}

// Функции для модального окна аренды
function openRentModal(carId, carName) {
    const modal = document.getElementById('rentModal');
    document.getElementById('rentCarName').textContent = carName;
    document.getElementById('rentDailyPrice').textContent = '{{ car.daily_rent }} ₽/сутки';
    document.getElementById('rentWeeklyPrice').textContent = '{{ car.weekly_discount }} ₽/сутки';
    modal.style.display = 'flex';
}

function closeRentModal() {
    document.getElementById('rentModal').style.display = 'none';
}

function openContactModal(carName) {
    if (typeof Telegram !== 'undefined') {
        const tg = window.Telegram.WebApp;
        const message = `Здравствуйте! Интересует консультация по автомобилю: ${carName}`;
        tg.openTelegramLink(`https://t.me/chiauto_contact_bot?start=${encodeURIComponent(message)}`);
    } else {
        showTelegramAlert('Для консультации перейдите в наш Telegram: @chiauto_contact_bot');
    }
}

function shareCar(carId) {
    const carUrl = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: '{{ car.name }} - CHI AUTO',
            text: 'Посмотрите этот автомобиль в CHI AUTO',
            url: carUrl
        });
    } else {
        showTelegramAlert('Ссылка на автомобиль скопирована в буфер обмена');
        navigator.clipboard.writeText(carUrl);
    }
}

// Обработчик формы аренды
document.getElementById('rentForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = {
        carId: '{{ car.id }}',
        carName: '{{ car.name }}',
        name: document.getElementById('rentName').value,
        phone: document.getElementById('rentPhone').value,
        city: document.getElementById('rentCity').value,
        dates: document.getElementById('rentDates').value,
        comment: document.getElementById('rentComment').value
    };

    // Здесь можно отправить данные на сервер
    console.log('Rent form submitted:', formData);

    showTelegramAlert('Заявка на аренду отправлена! Мы свяжемся с вами в ближайшее время.');
    closeRentModal();
    this.reset();
});

// Закрытие модального окна при клике вне его
document.addEventListener('click', function(e) {
    const modal = document.getElementById('rentModal');
    if (e.target === modal) {
        closeRentModal();
    }
});

// Закрытие при нажатии ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeRentModal();
    }
});
</script>
{% endblock %}